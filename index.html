<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feliz Anivers√°rio, Fernando! üéâ</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#1b0f2a;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.12);
      --text:#eef2ff;
      --muted:#b9c0ff;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 20%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 600px at 90% 15%, rgba(34,197,94,.25), transparent 55%),
        radial-gradient(900px 700px at 70% 95%, rgba(251,113,133,.20), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 18px 44px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 18px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .badge{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(124,58,237,.9), rgba(34,197,94,.75));
      box-shadow: var(--shadow);
      font-size:20px;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .brand p{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }

    .pill{
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
      display:flex; gap:8px; align-items:center;
      backdrop-filter: blur(10px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
    }

    @media (max-width: 880px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 240px at 30% 0%, rgba(124,58,237,.22), transparent 55%);
      pointer-events:none;
    }

    .title{
      font-size: 26px;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .subtitle{
      margin:0 0 14px;
      color: var(--muted);
      line-height:1.45;
    }

    .timer{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .tbox{
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 14px 12px;
      text-align:center;
    }
    .tbox .num{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .5px;
    }
    .tbox .lab{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.25px;
      text-transform: uppercase;
    }

    .btn{
      width: 100%;
      border: none;
      cursor: pointer;
      margin-top: 14px;
      padding: 14px 14px;
      border-radius: 18px;
      font-weight: 800;
      font-size: 15px;
      letter-spacing:.2px;
      color: #0b1020;
      background: linear-gradient(135deg, #a78bfa, #22c55e);
      box-shadow: 0 18px 45px rgba(34,197,94,.18);
      transition: transform .15s ease, filter .15s ease, opacity .15s ease;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; filter: grayscale(.2); }

    .hint{
      margin-top:10px;
      font-size: 12px;
      color: rgba(238,242,255,.75);
      line-height:1.4;
    }

    .rightTop{
      display:flex; flex-direction:column; gap:10px;
    }

    .mini{
      padding: 14px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .mini h3{ margin:0 0 6px; font-size: 14px; letter-spacing:.2px; }
    .mini p{ margin:0; color: var(--muted); font-size: 12.5px; line-height:1.45; }

    .stage{
      margin-top: 16px;
      display:none;
      animation: fadeIn .6s ease both;
    }
    .stage.active{ display:block; }

    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0px); }
    }

    .heroName{
      display:flex; flex-wrap:wrap;
      gap:8px; align-items:baseline;
      margin: 0 0 10px;
    }
    .heroName .big{
      font-size: 28px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .heroName .age{
      font-size: 14px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
    }

    /* Carousel */
    .carousel{
      position: relative;
      border-radius: 20px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      margin: 10px 0 14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      aspect-ratio: 16 / 9;
    }
    .slides{
      height:100%;
      display:flex;
      transition: transform .5s ease;
    }
    .slide{
      min-width: 100%;
      height:100%;
      position:relative;
    }
    .slide img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: contrast(1.02) saturate(1.02);
    }
    .fadeEdge{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 300px at 50% 90%, rgba(0,0,0,.55), transparent 55%),
        linear-gradient(to top, rgba(0,0,0,.55), transparent 40%);
      pointer-events:none;
    }

    .carControls{
      position:absolute;
      inset: 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 0 10px;
      pointer-events:none;
    }
    .carBtn{
      pointer-events:auto;
      width:42px;height:42px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color: var(--text);
      display:grid; place-items:center;
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .12s ease, background .12s ease;
    }
    .carBtn:hover{ transform: scale(1.04); background: rgba(0,0,0,.32); }
    .carBtn:active{ transform: scale(.98); }

    .dots{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 10px;
      display:flex;
      gap: 7px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
    }
    .dot{
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
      cursor:pointer;
    }
    .dot.active{ background: rgba(255,255,255,.92); }

    /* Message */
    .msg{
      margin-top: 10px;
      padding: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      line-height:1.6;
      color: rgba(238,242,255,.92);
      white-space: pre-wrap;
    }

    .spotify{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .linkBtn{
      border:none;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      letter-spacing:.2px;
      background: linear-gradient(135deg, #22c55e, #34d399);
      color:#06230f;
      box-shadow: 0 18px 40px rgba(34,197,94,.18);
      transition: transform .15s ease, filter .15s ease;
      display:flex; align-items:center; gap:10px;
      text-decoration:none;
    }
    .linkBtn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .linkBtn:active{ transform: translateY(0px) scale(.99); }

    .ghostBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 800;
      transition: transform .15s ease, background .15s ease;
    }
    .ghostBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .ghostBtn:active{ transform: translateY(0px) scale(.99); }

    /* Balloons */
    .balloons{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 50;
    }
    .balloon{
      position:absolute;
      width: 42px;
      height: 54px;
      border-radius: 999px 999px 999px 999px;
      filter: drop-shadow(0 12px 15px rgba(0,0,0,.25));
      opacity:.95;
      transform: translateY(110vh);
      animation: floatUp linear forwards;
    }
    .balloon::after{
      content:"";
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom:-9px;
      width:0;height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-top:10px solid rgba(255,255,255,.35);
      mix-blend-mode: overlay;
      opacity:.35;
    }
    .string{
      position:absolute;
      left:50%;
      top: 52px;
      width:2px;
      height: 120px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.25);
      border-radius: 999px;
      opacity:.55;
    }
    @keyframes floatUp{
      to{ transform: translateY(-140vh); }
    }

    /* Confetti canvas */
    canvas#confetti{
      position:fixed;
      inset:0;
      z-index: 60;
      pointer-events:none;
      opacity:0;
      transition: opacity .3s ease;
    }
    canvas#confetti.on{ opacity:1; }

    /* ‚ÄúUnlocked‚Äù glow */
    .glow{
      position:absolute;
      inset:-2px;
      border-radius: var(--radius);
      background: radial-gradient(600px 260px at 40% -10%, rgba(34,197,94,.22), transparent 60%);
      pointer-events:none;
      opacity:0;
      transition: opacity .35s ease;
    }
    .glow.on{ opacity:1; }

    footer{
      margin-top: 16px;
      color: rgba(238,242,255,.6);
      font-size: 12px;
      text-align:center;
    }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="balloons" id="balloons"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="badge">üéÇ</div>
        <div>
          <h1>Anivers√°rio do Fernando</h1>
          <p>Site surpresa ‚Äî libera no hor√°rio certo</p>
        </div>
      </div>
      <div class="pill" id="statusPill">‚è≥ aguardando 05/02 00:00</div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="glow" id="glow"></div>
        <h2 class="title">Contagem regressiva</h2>
        <p class="subtitle">
          Quando der <b>00:00</b> do dia <b>05/02</b>, o bot√£o libera.
        </p>

        <div class="timer" aria-label="contador">
          <div class="tbox"><div class="num" id="d">00</div><div class="lab">Dias</div></div>
          <div class="tbox"><div class="num" id="h">00</div><div class="lab">Horas</div></div>
          <div class="tbox"><div class="num" id="m">00</div><div class="lab">Min</div></div>
          <div class="tbox"><div class="num" id="s">00</div><div class="lab">Seg</div></div>
        </div>

        <button class="btn" id="enterBtn" disabled>
          üîí Ainda n√£o‚Ä¶ falta pouco
        </button>

        <div class="hint" id="hint">
          Dica: deixe o volume do celular ligado üòÑ
        </div>
      </section>

      <aside class="rightTop">
        <div class="mini">
          <h3>O que acontece quando clicar?</h3>
          <p>
            Bal√µes + confete + ‚ÄúHappy Birthday‚Äù por ~15s,
            e depois aparece um carrossel com as fotos e a mensagem.
          </p>
        </div>
        <div class="mini">
          <h3>Se abrir depois do hor√°rio</h3>
          <p>
            O bot√£o j√° fica liberado automaticamente.
          </p>
        </div>
      </aside>
    </div>

    <section class="card stage" id="stage">
      <div class="heroName">
        <div class="big" id="personName">Fernando Kaynan Barbosa</div>
        <div class="age" id="personAge">21 anos üéâ</div>
      </div>

      <div class="carousel" aria-label="Carrossel de fotos">
        <div class="slides" id="slides"></div>

        <div class="carControls">
          <button class="carBtn" id="prev" aria-label="Anterior">‚Äπ</button>
          <button class="carBtn" id="next" aria-label="Pr√≥xima">‚Ä∫</button>
        </div>

        <div class="dots" id="dots" aria-label="Indicadores"></div>
      </div>

      <div class="msg" id="msg"></div>

      <div class="spotify">
        <a class="linkBtn" id="spotifyBtn" href="#" target="_blank" rel="noopener">
          üéµ Abrir m√∫sica no Spotify
        </a>
        <button class="ghostBtn" id="replay">
          üîÅ Repetir bal√µes + confete
        </button>
      </div>
    </section>

    <footer>
      Feito com carinho ‚ú®
    </footer>
  </div>

  <script>
    /***********************
     * CONFIGURA√á√ïES
     ***********************/
    const PERSON_NAME = "Fernando Kaynan Barbosa";
    const PERSON_AGE = 21;
    // Contagem: 05/02 00:00 (usa o ano atual do dispositivo; se j√° passou, usa o ano atual mesmo)
    const TARGET_MONTH = 1; // fevereiro = 1 (0=jan)
    const TARGET_DAY = 5;
    const TARGET_HOUR = 0;
    const TARGET_MIN = 0;

    // Coloque suas fotos em /fotos e renomeie. Ex:
    // fotos/1.jpg, fotos/2.jpg, fotos/3.jpg ...
    const PHOTO_LIST = [
      "fotos/1.jpg",
      "fotos/2.jpg",
      "fotos/3.jpg",
      "fotos/4.jpg",
      "fotos/5.jpg",
      "fotos/6.jpg",
      "fotos/7.jpg",
      "fotos/8.jpg",
      "fotos/9.jpg",
    ];

    const MESSAGE_TEXT =
`irm√£o, mas eu espero ter conseguido passar tudo que eu tinha que te passar com as minhas palavras, eu realmente escrevi isso do fundo do meu cora√ß√£o.

Quero que saiba que eu te amo muito man e que pode contar comigo pra tudo que vier!

gostaria de dedicar uma m√∫sica pra voc√™, ela acabou aparecendo pra mim nos aleat√≥rios do Spotify e estava esperando o momento certo pra te entregar ela`;

    const SPOTIFY_LINK = "https://open.spotify.com/track/65gLJGey4u4KFFqoC5fzFJ?si=ppYfg_K3SrGM4T2OTT-zPQ";

    // Dura√ß√£o dos efeitos e da m√∫sica
    const PARTY_DURATION_MS = 15000;

    /***********************
     * ELEMENTOS
     ***********************/
    const $ = (id) => document.getElementById(id);

    const dEl = $("d"), hEl = $("h"), mEl = $("m"), sEl = $("s");
    const enterBtn = $("enterBtn");
    const statusPill = $("statusPill");
    const hint = $("hint");
    const glow = $("glow");

    const stage = $("stage");
    const slides = $("slides");
    const dots = $("dots");
    const prev = $("prev");
    const next = $("next");

    const balloonsWrap = $("balloons");
    const confettiCanvas = $("confetti");
    const msg = $("msg");
    const personName = $("personName");
    const personAge = $("personAge");
    const spotifyBtn = $("spotifyBtn");
    const replayBtn = $("replay");

    /***********************
     * DATA / CONTAGEM
     ***********************/
    function getTargetDate(){
      const now = new Date();
      const year = now.getFullYear();
      let target = new Date(year, TARGET_MONTH, TARGET_DAY, TARGET_HOUR, TARGET_MIN, 0, 0);
      // se j√° passou e voc√™ abriu depois, deixa liberado (n√£o joga pro pr√≥ximo ano)
      return target;
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    function updateCountdown(){
      const now = new Date();
      const target = getTargetDate();
      let diff = target - now;

      if (diff <= 0){
        dEl.textContent = "00";
        hEl.textContent = "00";
        mEl.textContent = "00";
        sEl.textContent = "00";
        unlock();
        return;
      }

      const sec = Math.floor(diff/1000);
      const days = Math.floor(sec / 86400);
      const hours = Math.floor((sec % 86400)/3600);
      const mins = Math.floor((sec % 3600)/60);
      const secs = sec % 60;

      dEl.textContent = pad2(days);
      hEl.textContent = pad2(hours);
      mEl.textContent = pad2(mins);
      sEl.textContent = pad2(secs);

      // Mensagem pill
      statusPill.textContent = "‚è≥ faltam " + pad2(hours) + ":" + pad2(mins) + ":" + pad2(secs);
    }

    let unlocked = false;
    function unlock(){
      if (unlocked) return;
      unlocked = true;

      enterBtn.disabled = false;
      enterBtn.textContent = "üéâ Entrar";
      statusPill.textContent = "‚úÖ liberado! feliz 05/02";
      hint.textContent = "Agora pode clicar üòÑ";
      glow.classList.add("on");
    }

    /***********************
     * CARROSSEL
     ***********************/
    let idx = 0;
    let autoTimer = null;

    function renderCarousel(){
      slides.innerHTML = "";
      dots.innerHTML = "";

      PHOTO_LIST.forEach((src, i) => {
        const s = document.createElement("div");
        s.className = "slide";
        s.innerHTML = `
          <img src="${src}" alt="Foto ${i+1}">
          <div class="fadeEdge"></div>
        `;
        slides.appendChild(s);

        const dot = document.createElement("div");
        dot.className = "dot" + (i===0 ? " active":"");
        dot.addEventListener("click", () => goTo(i));
        dots.appendChild(dot);
      });

      applyIndex();
      startAuto();
    }

    function applyIndex(){
      slides.style.transform = `translateX(${-idx*100}%)`;
      [...dots.children].forEach((d,i)=>d.classList.toggle("active", i===idx));
    }

    function goTo(i){
      idx = (i + PHOTO_LIST.length) % PHOTO_LIST.length;
      applyIndex();
      restartAuto();
    }

    function startAuto(){
      if (autoTimer) return;
      autoTimer = setInterval(()=> goTo(idx+1), 3200);
    }
    function stopAuto(){
      if (!autoTimer) return;
      clearInterval(autoTimer);
      autoTimer = null;
    }
    function restartAuto(){
      stopAuto();
      startAuto();
    }

    prev.addEventListener("click", ()=> goTo(idx-1));
    next.addEventListener("click", ()=> goTo(idx+1));

    /***********************
     * BAL√ïES
     ***********************/
    function rand(min,max){ return Math.random()*(max-min)+min; }

    function createBalloon(){
      const b = document.createElement("div");
      b.className = "balloon";
      const left = rand(2, 98);
      const dur = rand(6.5, 11.5);
      const size = rand(34, 56);

      b.style.left = left + "vw";
      b.style.animationDuration = dur + "s";
      b.style.width = size + "px";
      b.style.height = (size*1.25) + "px";

      const hue = Math.floor(rand(0, 360));
      b.style.background = `linear-gradient(180deg, hsla(${hue},90%,70%,.95), hsla(${hue},90%,55%,.95))`;

      const string = document.createElement("div");
      string.className = "string";
      string.style.height = rand(80, 160) + "px";
      b.appendChild(string);

      b.addEventListener("animationend", () => b.remove());
      balloonsWrap.appendChild(b);
    }

    function balloonBurst(ms){
      const start = Date.now();
      const pop = setInterval(() => {
        for (let i=0;i<3;i++) createBalloon();
        if (Date.now() - start > ms) clearInterval(pop);
      }, 140);
    }

    /***********************
     * CONFETTI (canvas)
     ***********************/
    function setupConfetti(){
      const ctx = confettiCanvas.getContext("2d");
      function resize(){
        confettiCanvas.width = window.innerWidth * devicePixelRatio;
        confettiCanvas.height = window.innerHeight * devicePixelRatio;
      }
      window.addEventListener("resize", resize);
      resize();

      let pieces = [];
      let running = false;
      let raf = null;

      function spawn(){
        const count = 180;
        pieces = Array.from({length: count}).map(()=>({
          x: Math.random()*confettiCanvas.width,
          y: -Math.random()*confettiCanvas.height*0.2,
          w: (6 + Math.random()*10)*devicePixelRatio,
          h: (8 + Math.random()*16)*devicePixelRatio,
          vx: (-1 + Math.random()*2) * 1.3 * devicePixelRatio,
          vy: (2.2 + Math.random()*4.2) * devicePixelRatio,
          rot: Math.random()*Math.PI,
          vr: (-.08 + Math.random()*.16),
          hue: Math.floor(Math.random()*360)
        }));
      }

      function draw(){
        ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
        for (const p of pieces){
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;

          if (p.y > confettiCanvas.height + 40*devicePixelRatio){
            p.y = -20*devicePixelRatio;
            p.x = Math.random()*confettiCanvas.width;
          }
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = `hsla(${p.hue}, 95%, 62%, .95)`;
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.restore();
        }
        raf = requestAnimationFrame(draw);
      }

      function start(ms){
        if (running) return;
        running = true;
        confettiCanvas.classList.add("on");
        spawn();
        draw();
        setTimeout(() => stop(), ms);
      }

      function stop(){
        if (!running) return;
        running = false;
        confettiCanvas.classList.remove("on");
        if (raf) cancelAnimationFrame(raf);
        ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      }

      return { start, stop };
    }

    const confetti = setupConfetti();

    /***********************
     * ‚ÄúHAPPY BIRTHDAY‚Äù SINTETIZADO (WebAudio)
     * (melodia √© dom√≠nio p√∫blico; aqui √© gerada por osciladores)
     ***********************/
    let audioCtx = null;
    let stopAudioTimer = null;

    // Frequ√™ncias (A4=440). Vamos usar notas aproximadas pra tocar a melodia.
    const NOTES = {
      C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00, B4: 493.88,
      C5: 523.25, D5: 587.33, E5: 659.25, F5: 698.46, G5: 783.99
    };

    // Sequ√™ncia simples (Happy Birthday) ‚Äî aproximada em C
    const HAPPY_SEQ = [
      ["G4", .35], ["G4", .20], ["A4", .55], ["G4", .55], ["C5", .55], ["B4", .90],
      ["G4", .35], ["G4", .20], ["A4", .55], ["G4", .55], ["D5", .55], ["C5", .90],
      ["G4", .35], ["G4", .20], ["G5", .55], ["E5", .55], ["C5", .55], ["B4", .55], ["A4", .90],
      ["F5", .35], ["F5", .20], ["E5", .55], ["C5", .55], ["D5", .55], ["C5", 1.10],
    ];

    function ensureAudio(){
      if (audioCtx) return audioCtx;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    function playHappyBirthdayFor(ms){
      const ctx = ensureAudio();
      // iOS/Chrome: precisa de gesto do usu√°rio ‚Äî isso roda no clique do bot√£o, ok.
      ctx.resume?.();

      const master = ctx.createGain();
      master.gain.value = 0.12;
      master.connect(ctx.destination);

      let t = ctx.currentTime + 0.02;

      function playOne(freq, dur){
        const o = ctx.createOscillator();
        const g = ctx.createGain();

        o.type = "triangle";
        o.frequency.value = freq;

        // envelope
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(1.0, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

        o.connect(g);
        g.connect(master);

        o.start(t);
        o.stop(t + dur);

        t += dur + 0.03;
      }

      // repete a m√∫sica em loop at√© dar o tempo
      const startTime = ctx.currentTime;
      function scheduleLoop(){
        let loopEnd = t;
        for (const [name, dur] of HAPPY_SEQ){
          playOne(NOTES[name], dur);
        }
        loopEnd = t;

        // se ainda tem tempo, agenda mais
        if ((loopEnd - startTime) * 1000 < ms - 250){
          scheduleLoop();
        }
      }

      scheduleLoop();

      // para com fade
      clearTimeout(stopAudioTimer);
      stopAudioTimer = setTimeout(() => {
        const now = ctx.currentTime;
        master.gain.setTargetAtTime(0.0001, now, 0.06);
      }, ms);

      return () => {
        const now = ctx.currentTime;
        master.gain.setTargetAtTime(0.0001, now, 0.06);
      };
    }

    /***********************
     * FLUXO PRINCIPAL
     ***********************/
    function showStage(){
      personName.textContent = PERSON_NAME;
      personAge.textContent = `${PERSON_AGE} anos üéâ`;
      msg.textContent = MESSAGE_TEXT;
      spotifyBtn.href = SPOTIFY_LINK;

      stage.classList.add("active");
      renderCarousel();
      stage.scrollIntoView({behavior:"smooth", considerInline:false});
    }

    function party(){
      // efeitos
      confetti.start(PARTY_DURATION_MS);
      balloonBurst(PARTY_DURATION_MS);

      // m√∫sica
      const stop = playHappyBirthdayFor(PARTY_DURATION_MS);

      // depois mostra conte√∫do
      setTimeout(() => {
        stop?.();
        showStage();
      }, PARTY_DURATION_MS);
    }

    enterBtn.addEventListener("click", () => {
      if (!unlocked) return;
      enterBtn.disabled = true;
      enterBtn.textContent = "üéä Surpresa!";
      statusPill.textContent = "üéâ FELIZ ANIVERS√ÅRIO!";
      party();
    });

    replayBtn.addEventListener("click", () => {
      confetti.start(6500);
      balloonBurst(6500);
      try { playHappyBirthdayFor(6500); } catch(e) {}
    });

    /***********************
     * INICIALIZA
     ***********************/
    // Se o usu√°rio abrir depois do hor√°rio (05/02 00:00), libera na hora.
    (function init(){
      // pr√©-preenche carrossel quando abrir (vai mostrar depois do party)
      msg.textContent = MESSAGE_TEXT;

      updateCountdown();
      setInterval(updateCountdown, 250);

      // libera√ß√£o imediata se j√° passou
      const now = new Date();
      const target = getTargetDate();
      if (now >= target) unlock();
    })();
  </script>
</body>
</html>
